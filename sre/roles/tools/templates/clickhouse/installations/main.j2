---
apiVersion: v1
kind: Secret
metadata:
  name: user-default-credentials
  namespace: {{ tools_instances.clickhouse.namespace }}
type: Opaque
stringData:
  user: default
  password: ""
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallationTemplate
metadata:
  name: clickhouse-pod
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.6.10034
spec:
  templates:
    podTemplates:
      - name: clickhouse-pod
        metadata:
          annotations:
            openshift.io/required-scc: restricted-v2
          labels:
            app.kubernetes.io/name: clickhouse
            app.kubernetes.io/version: 25.3.6.10034
        spec:
          securityContext:
            fsGroup: 101
            runAsGroup: 101
            runAsNonRoot: true
            runAsUser: 101
            seccompProfile:
              type: "RuntimeDefault"
          containers:
            - name: clickhouse
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
              image: docker.io/altinity/clickhouse-server:25.3.6.10034.altinitystable
              imagePullPolicy: IfNotPresent
              resources:
                requests:
                  cpu: 100m
                  memory: 2Gi
                limits:
                  memory: 3Gi
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallationTemplate
metadata:
  name: clickhouse-data
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.6.10034
spec:
  templates:
    volumeClaimTemplates:
      - name: clickhouse-data
        reclaimPolicy: Retain
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 15Gi
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallationTemplate
metadata:
  name: clickhouse-service
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.6.10034
spec:
  templates:
    serviceTemplates:
      - name: clickhouse-service
        metadata:
          labels:
            app.kubernetes.io/name: clickhouse
            app.kubernetes.io/version: 25.3.6.10034
        spec:
          type: ClusterIP
          ports:
            - name: http
              port: 8123
              targetPort: 8123
            - name: tcp
              port: 9000
              targetPort: 9000
          selector:
            app.kubernetes.io/name: clickhouse
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: {{ tools_instances.clickhouse.names.main }}
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.6.10034
spec:
  defaults:
    templates:
      dataVolumeClaimTemplate: clickhouse-data
      podTemplate: clickhouse-pod
      serviceTemplate: clickhouse-service
  useTemplates:
    - name: clickhouse-data
    - name: clickhouse-pod
    - name: clickhouse-service
  configuration:
    users:
      default/networks/ip: 0.0.0.0/0
      default/access_management: 1
      default/named_collection_control: 1
      default/show_named_collections: 1
      default/show_named_collections_secrets: 1
      default/password:
        valueFrom:
          secretKeyRef:
            name: user-default-credentials
            key: password
    clusters:
      - name: main
        layout:
          shardsCount: 1
          replicasCount: 1
