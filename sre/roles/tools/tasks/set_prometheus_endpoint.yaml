---
- name: Retrieve bearer token for Prometheus
  when:
    - tools_cluster.platform == "openshift"
  block:
    - name: Retrieve bearer token from OpenShift CLI
      ansible.builtin.command:
        argv:
          - oc
          - whoami
          - -t
          - --kubeconfig={{ tools_cluster.kubeconfig | ansible.builtin.expanduser }}
      register: tools_oc_user_token
      changed_when: false
      failed_when: tools_oc_user_token.rc != 0

    - name: Extract Prometheus hostname and bearer token
      ansible.builtin.set_fact:
        tools_prometheus_bearer_token: "{{ tools_oc_user_token.stdout }}"

- name: Retrieve Prometheus information
  kubernetes.core.k8s_info:
    api_version: monitoring.coreos.com/v1
    kind: Prometheus
    kubeconfig: "{{ tools_cluster.kubeconfig }}"
    name: "{{ 'prometheus-k8s' if tools_cluster.platform == 'openshift' else (tools_helm_releases.prometheus.name + '-kube-prometheus-prometheus') }}"
    namespace: "{{ 'openshift-monitoring' if tools_cluster.platform == 'openshift' else tools_helm_releases.prometheus.namespace }}"
  register: tools_prometheus

- name: Verify that object exists
  ansible.builtin.assert:
    that:
      - tools_prometheus is defined
      - tools_prometheus.resources | length == 1
    fail_msg: Unable to find information for Prometheus Please verify that Prometheus is installed.
    success_msg: Found installation information for Prometheus.

- name: Extract in-cluster endpoint for Prometheus
  ansible.builtin.set_fact:
    tools_prometheus_endpoint: "{{ tools_prometheus.resources[0].spec.externalUrl }}{{ tools_prometheus.resources[0].spec.routePrefix }}"
