---
- name: Retrieve Gateway with assigned address
  kubernetes.core.k8s_info:
    api_version: gateway.networking.k8s.io/v1
    kind: Gateway
    kubeconfig: "{{ tools_cluster.kubeconfig }}"
    name: "{{ tools_kubernetes_gateway.name }}"
    namespace: "{{ tools_instances.kubernetes_gateways.namespace }}"
  register: tools_gateway
  until:
    - tools_gateway.resources | length == 1
    - tools_gateway.resources[0].status.addresses | default([]) | length > 0
  delay: 15
  retries: 20

- name: Extract ip address information
  ansible.builtin.set_fact:
    tools_gateway_http_endpoint: http://{{ tools_gateway.resources[0].status.addresses[0].value }}:80
  when:
    - tools_gateway.resources[0].status.addresses[0].type == "IPAddress"

- name: Extract hostname address information
  ansible.builtin.set_fact:
    tools_gateway_http_endpoint: http://{{ tools_gateway.resources[0].status.addresses[0].value }}
  when:
    - tools_gateway.resources[0].status.addresses[0].type == "Hostname"

- name: Attempt connection test to additional endpoints
  ansible.builtin.uri:
    url: "{{ test_url }}"
  loop: |
    {{
      [
        tools_gateway_http_endpoint | default('')
      ] |
      product(tools_external_paths) |
      map('join', "")
    }}
  loop_control:
    label: "{{ test_url }}"
    loop_var: test_url
  delay: 15
  retries: 12
