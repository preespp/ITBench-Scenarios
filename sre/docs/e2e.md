# ITBench: End-to-End (E2E) Execution

An end-to-end execution is a workflow which goes through the every phase of the benchmarking process (set up, agent execution, and clean up). To orchestrate this system, ITBench uses [AWX](https://github.com/ansible/awx).

## Setup and Execution

### Step 1: Initialize Group Variables

In order to generate the required group variables for the playbook execution, run the following command:

```bash
make -f Makefile.runner group_vars
```

### Step 2: Create Kubernetes Cluster(s)

E2E execution makes use of multiple clusters in order to parallelize scenario execution. This allows multiple scenarios to be tested at the same time. **However, this requires that there is a cluster for every scenario.**

If using the [resources provided for remote cluster development](../dev/remote_cluster/README.md#cluster-management---multiple-clusters), follow the instructions given. Once the clusters have been created, run the following command to export the kubeconfigs and update the `stack.yaml` group variable that was created in the previous step.

```bash
make export_awx_kubeconfigs
```

If using the [resources provided for local cluster development](../dev/local_cluster/Makefile) can be used to make a cluster which can run AWX and a single scenario at the same time by running the following command:

```bash
make create_multi_node_cluster
```

However, it is [quite resource intensive](./hardware_specification.md#development-on-awx). As such, running AWX locally is not recommended for use outside of testing purposes.

If not using the resources provided, the `stack.yaml` file in the `group_var/runner` directory must be manually updated with the absolute file paths of the kubeconfigs belonging to the clusters. We recommend having a separate cluster to be the head. Thus, to run end-to-end on AWX, X + 1 clusters are needed (X is the number of scenarios that will be tested).

### Step 3: Configure Group Variables

_Note:_ Depending on how the Kubernetes cluster(s) are provisioned, `stack.yaml` may need to be updated.

The [group variables](../group_vars/runner/) generated by [Step 1](#step-1-initialize-group-variables) might need to be configured.

Below is an explanantion of each group variable and a [configuration reference](#configuration-reference).

- **agent.yaml** - Agent configuration including LLM endpoints and API keys
- **credentials.yaml** - AWS credentials for cloud resources
- **experiments.yaml** - Scenario selection and trial configuration
- **github.yaml** - GitHub repository settings for test scenarios
- **stack.yaml** - Kubernetes configuration pointers (auto-populated)

### Step 4: Deploy AWX Stack

Install AWX on the selected cluster:

```bash
make -f Makefile.runner deploy_awx_stack
```

**Verify deployment** by checking that all pods are running:

```bash
export KUBECONFIG=<path to the head cluster>
kubectl get pods -n awx
```

Expected output:
```
NAME                                               READY   STATUS      RESTARTS   AGE
awx-deployment-migration-24.6.1-sbcb9              0/1     Completed   0          4h2m
awx-deployment-postgres-15-0                       1/1     Running     0          4h2m
awx-deployment-task-5df79dbc47-k8mcb               4/4     Running     0          4h2m
awx-deployment-web-744655bd58-q8958                3/3     Running     0          4h2m
awx-operator-controller-manager-645d4f8c74-pcd52   2/2     Running     0          4h3m
```

### Step 5: Access AWX Console

Open your browser and navigate to...

Local AWX: [http://127.0.0.1:30950/ui_next/overview](http://127.0.0.1:30950/ui_next/overview)

Remote AWX:

```bash
kubectl -n awx get service awx-deployment-service --template={{.status.loadBalancer.ingress[0].hostname}} --kubeconfig=<path to kubeconfig>
```

**Login credentials:**
- Username: `admin`
- Password: Retrieve using the command below:

```bash
KUBECONFIG=<path_to_kubeconfig> kubectl get secret awx-deployment-admin-password -n awx --template={{.data.password}} | base64 -d
```

### Step 6: Configure AWX Pipeline

Set up job templates and workflows for your test scenarios:

```bash
make -f Makefile.runner configure_awx_pipeline
```

### Step 7: Configure AWX Pipeline

To install the tools for each scenario on the runner clusters, run the following command:

```bash
make -f Makefile.runner launch_init_workflow
```

### Step 8: Launch Test Execution

In order to run the scenarios for X trials (defined in `experiments.yaml`) on the runner clusters, run the following command:

```bash
make -f Makefile.runner launch_full_workflow
```

### Step 9: Monitor Execution

After launching the workflow, monitor progress in the AWX console: [http://127.0.0.1:30950/ui_next/jobs?page=1&perPage=10&sort=-finished](http://127.0.0.1:30950/ui_next/jobs?page=1&perPage=10&sort=-finished)

### Step 10: Cleanup

Once all trials have been completed, run the following command to remove the tools from all runner clusters:

```bash
make -f Makefile.runner launch_deinit_workflow
```

Then, run the following command to uninstall AWX from the head cluster:

```bash
make -f Makefile.runner undeploy_awx_stack
```

## Configuration Reference

The group variable files control various aspects of AWX environment. Here's how to configure each file:

### Agent Configuration (agent.yaml)

Controls the SRE agent behavior and LLM integration. The ones below primarily go into effect while running the baseline ITBench SRE Agent provided [here](https://github.com/itbench-hub/ITBench-SRE-Agent).

```yaml
agent_configuration:
  version: "sre-agent-v1"
  configuration:
    agents_config:
      provider: "openai"              # LLM provider (openai, watsonx, etc.)
      model: "gpt-4o"                 # Model to use
      url: "https://api.openai.com/v1" # API endpoint
      api_key: "your-api-key-here"    # Your API key # pragma: allowlist secret
      seed: "42"                      # For reproducible results
      top_p: "0.1"                    # Sampling parameter
      temperature: "0.000001"         # Response randomness (lower = more deterministic)
      god_mode: true                  # Enable enhanced capabilities
    tools_config:
      # Similar configuration for tool-specific LLM usage
      provider: "openai"
      model: "gpt-4o"
      # ... (same parameters as agents_config)
    watsonx_config:
      wx_project_id: ""               # Required only if using watsonx
```

**Key settings to update:**
- Replace `api_key` with your actual OpenAI API key or alternate provider key
- Adjust `model` based on your subscription and requirements
- Modify `temperature` and `top_p` for desired response variability

### Credentials (credentials.yaml)

Configure AWS credentials for accessing cloud resources. This only needs to be configured for runs on AWS, not for local Kind cluster-based runs. Primarily the outputs from the experiment runs are uploaded.

```yaml
credentials:
  aws:
    access_key_id: "YOUR_ACCESS_KEY_ID"
    secret_access_key: "YOUR_SECRET_ACCESS_KEY" # pragma: allowlist secret
```

### Experiments (experiments.yaml)

List scenarios (referenced via scenario IDs) that are to be run and how many times (referreed to as trials):

```yaml
experiments:
  scenarios:
    - 1      # Uncomment scenarios you want to test
    # - 3
    # - 16
    # - 20
    # - 23
    # Add more scenario IDs as needed
  trials: 3  # Number of times to run each scenario
```

**Configuration tips:**
- The local Kind cluster setup supports one scenario at at time. There is a plan to extend this to allow for scenario runs one after the other.
- Increase `trials` for statistical significance
- Available scenarios and their respective scenario IDs in open source are documented [here](https://github.com/itbench-hub/ITBench-Scenarios/blob/main/sre/docs/incidents.md).

### GitHub Configuration (github.yaml)

Repository settings for test scenarios and agent code:

```yaml
github:
  it_bench:
    ssh:
      private_key_passphrase: "your-passphrase" # pragma: allowlist secret
      private_key_path: "/path/to/your/ssh/key"
    url: git@github.com:itbench-hub/ITBench-LeaderboardScenarios.git
    branch: v1-refactor-incidents
  llm_agent:
    url: https://github.com/itbench-hub/ITBench-SRE-Agent.git
    branch: switch-to-venv
```

**SSH key setup:**
- Generate an SSH key pair if you don't have one.
- Add the public key to your GitHub account
- Update `private_key_path` with your private key location
- Set `private_key_passphrase` if your key is encrypted
- The SSH key is setup is only needed if the repositories

### Stack Configuration (stack.yaml)

Kubernetes cluster configuration:

## For local Kind cluster based runs
```yaml
stack:
  awx:
    kubeconfig: ~/.kube/config       # Path to your local Kind clusters kubeconfig
  runners:
    kubeconfigs:
      - ~/.kube/config           # Path to your local Kind cluster kubeconfig with the appropriate host name
```

## For AWS based runs
Allows for multiple scenarios to run in across different available clusters. At this time we assume that each scenario has access to its own cluster.
